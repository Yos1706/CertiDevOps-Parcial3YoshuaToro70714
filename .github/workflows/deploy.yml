# .github/workflows/deploy.yml
name: CI/CD Pipeline - Build and Deploy to EC2 (Docker Hub Registry)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SSH_USER: ubuntu
  DEPLOY_PATH: CertiDevOps-Parcial2YoshuaToro70714
  # Variable para el tag de imagen (usa el SHA corto del commit)
  IMAGE_TAG: ${{ github.sha }}

jobs:

  # ===============================================
  # JOB 1: CI SETUP (Instalaci贸n y Verificaci贸n)
  # ===============================================
  ci-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
          
      - name: Install Backend Dependencies
        run: npm install
        working-directory: ./backend

      - name: Install Frontend Dependencies
        run: npm install
        working-directory: ./frontend
        

  # ===============================================
  # JOB 2: CONSTRUIR Y SUBIR IMGENES (PUSH a Docker Hub)
  # ===============================================
  build-and-push:
    # Necesita que el setup haya terminado 
    needs: [ci-setup] 
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      - name: 1. Login a Docker Hub
        # Utiliza un action para autenticar al runner con los secretos
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      # IMPORTANTE: Se usa la variable DOCKERHUB_USERNAME para el tag de la imagen
      # Esto asegura que la imagen sea tageada como "usuario/repo:tag"

      - name: 2.  Construir y Subir Imagen del Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-frontend-spa:${{ env.IMAGE_TAG }}, ${{ secrets.DOCKERHUB_USERNAME }}/my-frontend-spa:latest
          
      - name: 3.  Construir y Subir Imagen del Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/my-backend-api:${{ env.IMAGE_TAG }}, ${{ secrets.DOCKERHUB_USERNAME }}/my-backend-api:latest

  # ===============================================
  # JOB 3: DEPLOY A EC2 (Usando PULL del Registry)
  # ===============================================
  deploy:
    # Este job SOLO se ejecuta si build-and-push fue exitoso
    needs: [build-and-push] 
    runs-on: ubuntu-latest
    steps:
      
      - name: 1. Checkout C贸digo Fuente (Necesario para el docker-compose.yml actualizado)
        uses: actions/checkout@v4
        
      - name: 2. Configurar Clave SSH Privada
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: 3. Ejecutar Despliegue Remoto (SSH)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ env.SSH_USER }}@${{ secrets.EC2_HOST }} "
          
          # 3.1. Navegar y Actualizar C贸digo (Para obtener el docker-compose.yml con los tags de Docker Hub)
          cd ~/${{ env.DEPLOY_PATH }} && 
          git pull origin main && 

          # 3.2. Login en EC2 (Necesario para poder hacer docker-compose pull)
          # Utiliza los mismos secretos para autenticar el daemon de Docker en la EC2
          docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }} && 

          # 3.3. Detener y remover servicios viejos
          echo 'Deteniendo contenedores viejos...'
          sudo docker-compose down -v && 

          echo 'Descargando nuevas im谩genes desde Docker Hub...'
          sudo docker-compose pull && 

          # 3.4. Levantar los servicios con las im谩genes ya descargadas
          echo 'Desplegando nuevos contenedores...'
          sudo docker-compose up -d"
          
          echo 'Despliegue completado. Verificar en http://${{ secrets.EC2_HOST }}/'
